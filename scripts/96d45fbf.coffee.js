(function(){window.Cache=function(){function a(a,b){this.provider=a,this.max_entries=b,this.tiles={},this.lru=[]}return a.prototype.get=function(a,b){var c;return null==b&&(b=null),c=JSON.stringify(a),this.tiles[c]?(this.lru=_.without(this.lru,c),this.lru.push(c),b?b(null,this.tiles[c]):this.tiles[c]):b?this.provider(a,function(a){return function(d,e){return d?b(d):(a.tiles[c]=e,a.lru.push(c),a.lru.length>a.max_entries&&(a.tiles[a.lru[0]]=null,a.lru=a.lru.slice(1)),b(null,e))}}(this)):void 0},a}()}).call(this),function(){var a=function(a,b){return function(){return a.apply(b,arguments)}};window.PngMatrixProvider=function(){function b(b,c){this.png_url=b,this.callback=c,this.convert_img=a(this.convert_img,this),this.img=new Image,this.img.src=this.png_url,this.img.onload=this.convert_img}return b.prototype.convert_img=function(){var a,b,c,d;return a=document.createElement("canvas"),b=a.getContext("2d"),a.width=this.img.width,a.height=this.img.height,b.drawImage(this.img,0,0),c=new Uint8Array(b.getImageData(0,0,this.img.width,this.img.height).data),d=[216,512,512],this.img=void 0,this.callback(null,[c,d])},b}()}.call(this),function(){window.Matrix=function(){function a(a,b){this.array=a,this.shape=b}return a.prototype.pos=function(a,b,c){var d,e,f,g;return g=this.shape,f=g[0],e=g[1],d=g[2],a+f*(b+e*(c+d))},a.prototype.slice=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s;if(s=this.shape,l=s[0],j=s[1],h=s[2],c=this.array,0===a&&(f=[j,h]),1===a&&(f=[l,h]),2===a&&(f=[l,j]),d=function(a,b,c){return a*h*j+b*h+c},0===a)for(e=new Uint8Array(h*j),i=m=0;j>=0?j>m:m>j;i=j>=0?++m:--m)for(g=n=0;h>=0?h>n:n>h;g=h>=0?++n:--n)e[i*h+g]=c[b*h*j+i*h+g];if(1===a)for(e=new Uint8Array(l*h),k=o=0;l>=0?l>o:o>l;k=l>=0?++o:--o)for(g=p=0;h>=0?h>p:p>h;g=h>=0?++p:--p)e[k*h+g]=c[k*h*j+b*h+g];if(2===a)for(e=new Uint8Array(l*j),k=q=0;l>=0?l>q:q>l;k=l>=0?++q:--q)for(i=r=0;j>=0?j>r:r>j;i=j>=0?++r:--r)e[k*j+i]=c[k*h*j+i*h+b];return[e,f]},a}()}.call(this),function(){var a,b=function(a,b){return function(){return a.apply(b,arguments)}},c={}.hasOwnProperty,d=function(a,b){function d(){this.constructor=a}for(var e in b)c.call(b,e)&&(a[e]=b[e]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};a=function(a,b,c){function d(a,b,c){return 0>c&&(c+=1),c>1&&(c-=1),1/6>c?a+6*(b-a)*c:.5>c?b:2/3>c?a+(b-a)*(2/3-c)*6:a}var e,f,g;if(0==b)e=f=g=c;else{var h=.5>c?c*(1+b):c+b-c*b,i=2*c-h;e=d(i,h,a+1/3),f=d(i,h,a),g=d(i,h,a-1/3)}return[Math.round(255*e),Math.round(255*f),Math.round(255*g)]},window.DispView=function(c){function e(){return this.mouseWheel=b(this.mouseWheel,this),this.setControls=b(this.setControls,this),this.render=b(this.render,this),e.__super__.constructor.apply(this,arguments)}return d(e,c),e.prototype.initialize=function(b){var c,d,e,f,g,h;for(this.cols=[],f=h=0;256>=h;f=++h)this.cols[f]=a((256-f)/360,1,.5);return _.extend(this,_.pick(b,"overlay")),this.dims={cor:2,sag:1,tra:0},c=$("<div class='canvasWrapper'></div>"),this.$el.append(c),g=$("<div class='innerCanvasWrapper'></div>"),c.append(g),e=$("<canvas class='render_canvas' width='512' height='512'>"),this.canvas_scan=e.get(0),g.append(e),d=$("<canvas class='render_canvas' width='512' height='512'>"),this.canvas_overlay=d.get(0),g.append(this.canvas_overlay),this.input=$("<input class='slider' type='range'  min='0' max='216'/>"),this.$el.append(this.input),this.display=$("<div></div>"),this.$el.append(this.display),this.render(),this.model.on({change:this.render})},e.prototype.render=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o;if(i=this.model.get("slice_dim"),f=this.model.get("slice_"+i),this.input.val(f),this.input.prop("max",this.model.get("matrix_shape")[this.dims[i]]-1),this.display.html(f),matrices.scan){for(l=matrices.scan.slice(this.dims[i],f),c=l[0],h=l[1],this.canvas_scan.height=h[0],this.canvas_scan.width=h[1],b=this.canvas_scan.getContext("2d"),d=b.createImageData(this.canvas_scan.width,this.canvas_scan.height),e=d.data,g=j=0,m=h[0]*h[1];m>=0?m>j:j>m;g=m>=0?++j:--j)e[4*g]=c[g],e[4*g+1]=c[g],e[4*g+2]=c[g],e[4*g+3]=255;b.putImageData(d,0,0)}if(matrices[this.overlay]){for(n=matrices[this.overlay].slice(this.dims[i],f),c=n[0],h=n[1],this.canvas_overlay.height=h[0],this.canvas_overlay.width=h[1],b=this.canvas_overlay.getContext("2d"),d=b.createImageData(this.canvas_overlay.width,this.canvas_overlay.height),e=d.data,g=k=0,o=h[0]*h[1];o>=0?o>k:k>o;g=o>=0?++k:--k)a=this.cols[c[g]],e[4*g]=a[0],e[4*g+1]=a[1],e[4*g+2]=a[2],e[4*g+3]=c[g]<=24?5.3333*c[g]:128;return b.putImageData(d,0,0)}},e.prototype.setControls=function(){var a;return a=this.model.get("slice_dim"),this.model.set("slice_"+a,parseInt(this.input.val()))},e.prototype.mouseWheel=function(a){var b,c,d,e,f;return d=this.model.get("slice_dim"),b=this.model.get("slice_"+d),(null!=(e=a.originalEvent)?e.wheelDelta:void 0)>0&&(b+=1,c=this.model.get("matrix_shape")[this.dims[d]]-1,b>c&&(b=c)),(null!=(f=a.originalEvent)?f.wheelDelta:void 0)<0&&(b-=1,0>b&&(b=0)),this.model.set("slice_"+d,b),!1},e.prototype.events={"input input":"setControls","mousewheel canvas":"mouseWheel"},e}(Backbone.View)}.call(this),function(){var a=function(a,b){return function(){return a.apply(b,arguments)}},b={}.hasOwnProperty,c=function(a,c){function d(){this.constructor=a}for(var e in c)b.call(c,e)&&(a[e]=c[e]);return d.prototype=c.prototype,a.prototype=new d,a.__super__=c.prototype,a};window.DispInfoView=function(b){function d(){return this.updateModel=a(this.updateModel,this),this.render=a(this.render,this),d.__super__.constructor.apply(this,arguments)}return c(d,b),d.prototype.initialize=function(){var a;return a=$('<label class="radio-inline"> <input type="radio" name="slice" id="cor" value="cor"> Coronal </label> <label class="radio-inline"> <input type="radio" name="slice" id="sag" value="sag"> Sagittal </label> <label class="radio-inline"> <input type="radio" name="slice" id="tra" value="tra"> Transverse </label>'),this.$el.append(a),this.render,this.model.on({change:this.render})},d.prototype.render=function(){var a;return a=this.model.get("slice_dim"),this.$("#"+a).prop("checked",!0)},d.prototype.updateModel=function(){var a,b,c,d,e;for(d=["cor","tra","sag"],e=[],b=0,c=d.length;c>b;b++)a=d[b],e.push(this.$("#"+a).prop("checked")?this.model.set("slice_dim",a):void 0);return e},d.prototype.events={"change input[type=radio]":"updateModel"},d}(Backbone.View)}.call(this),function(){var a,b,c,d,e={}.hasOwnProperty,f=function(a,b){function c(){this.constructor=a}for(var d in b)e.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};a=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return f(b,a),b.prototype.defaults={slice_cor:276,slice_sag:250,slice_tra:108,matrix_shape:[216,512,512],scan_matrix:0,ctr_matrix:0,dose_matrix:0,slice_dim:"cor"},b}(Backbone.Model),window.matrices={},matrices.scan=new Matrix(new Uint8Array(56623104),[216,512,512]),c=new a,d=new DispView({overlay:"dose",model:c,el:".topleft"}),d=new DispView({overlay:"ctr",model:c,el:".topright"}),b=new DispInfoView({model:c,el:".top"}),new PngMatrixProvider("scan.png",function(a,b){var d,e;return d=b[0],e=b[1],matrices.scan=new Matrix(d,e),c.set({scan_matrix:c.get("scan_matrix")+1,matrix_shape:e})}),new PngMatrixProvider("ctr.png",function(a,b){var d,e;return d=b[0],e=b[1],matrices.ctr=new Matrix(d,e),c.set({ctr_matrix:c.get("ctr_matrix")+1})}),new PngMatrixProvider("dose.png",function(a,b){var d,e;return d=b[0],e=b[1],matrices.dose=new Matrix(d,e),c.set({dose_matrix:c.get("dose_matrix")+1})})}.call(this);