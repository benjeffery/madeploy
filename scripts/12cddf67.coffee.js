(function(){window.Cache=function(){function a(a,b){this.provider=a,this.max_entries=b,this.tiles={},this.lru=[]}return a.prototype.get=function(a,b){var c;return null==b&&(b=null),c=JSON.stringify(a),this.tiles[c]?(this.lru=_.without(this.lru,c),this.lru.push(c),b?b(null,this.tiles[c]):this.tiles[c]):b?this.provider(a,function(a){return function(d,e){return d?b(d):(a.tiles[c]=e,a.lru.push(c),a.lru.length>a.max_entries&&(a.tiles[a.lru[0]]=null,a.lru=a.lru.slice(1)),b(null,e))}}(this)):void 0},a}()}).call(this),function(){var a=function(a,b){return function(){return a.apply(b,arguments)}};window.PngMatrixProvider=function(){function b(b,c){this.png_url=b,this.callback=c,this.convert_img=a(this.convert_img,this),this.img=new Image,this.img.src=this.png_url,this.img.onload=this.convert_img}return b.prototype.convert_img=function(){var a,b,c,d;return a=document.createElement("canvas"),b=a.getContext("2d"),a.width=this.img.width,a.height=this.img.height,b.drawImage(this.img,0,0),c=new Uint8Array(b.getImageData(0,0,this.img.width,this.img.height).data),d=[216,512,512],this.img=void 0,this.callback(null,[c,d])},b}()}.call(this),function(){window.Matrix=function(){function a(a,b){this.array=a,this.shape=b}return a.prototype.pos=function(a,b,c){var d,e,f,g;return g=this.shape,f=g[0],e=g[1],d=g[2],a+f*(b+e*(c+d))},a.prototype.slice=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s;if(a===this.last_dim&&b===this.last_index)return this.last_result;if(s=this.shape,l=s[0],j=s[1],h=s[2],c=this.array,0===a&&(f=[j,h]),1===a&&(f=[l,h]),2===a&&(f=[l,j]),d=function(a,b,c){return a*h*j+b*h+c},0===a)for(e=new Uint8Array(h*j),i=m=0;j>=0?j>m:m>j;i=j>=0?++m:--m)for(g=n=0;h>=0?h>n:n>h;g=h>=0?++n:--n)e[i*h+g]=c[b*h*j+i*h+g];if(1===a)for(e=new Uint8Array(l*h),k=o=0;l>=0?l>o:o>l;k=l>=0?++o:--o)for(g=p=0;h>=0?h>p:p>h;g=h>=0?++p:--p)e[k*h+g]=c[k*h*j+b*h+g];if(2===a)for(e=new Uint8Array(l*j),k=q=0;l>=0?l>q:q>l;k=l>=0?++q:--q)for(i=r=0;j>=0?j>r:r>j;i=j>=0?++r:--r)e[k*j+i]=c[k*h*j+i*h+b];return this.last_dim=a,this.last_index=b,this.last_result=[e,f],[e,f]},a}()}.call(this),function(){var a,b=function(a,b){return function(){return a.apply(b,arguments)}},c={}.hasOwnProperty,d=function(a,b){function d(){this.constructor=a}for(var e in b)c.call(b,e)&&(a[e]=b[e]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};a=function(a,b,c){function d(a,b,c){return 0>c&&(c+=1),c>1&&(c-=1),1/6>c?a+6*(b-a)*c:.5>c?b:2/3>c?a+(b-a)*(2/3-c)*6:a}var e,f,g;if(0==b)e=f=g=c;else{var h=.5>c?c*(1+b):c+b-c*b,i=2*c-h;e=d(i,h,a+1/3),f=d(i,h,a),g=d(i,h,a-1/3)}return[Math.round(255*e),Math.round(255*f),Math.round(255*g)]},window.DispView=function(c){function e(){return this.mouseWheel=b(this.mouseWheel,this),this.setControls=b(this.setControls,this),this.render=b(this.render,this),e.__super__.constructor.apply(this,arguments)}return d(e,c),e.prototype.initialize=function(b){var c,d,e,f,g,h;for(this.cols=[],f=h=0;256>=h;f=++h)this.cols[f]=a((256-f)/360,1,.5);return _.extend(this,_.pick(b,"overlay")),_.extend(this,_.pick(b,"modality")),this.dims={cor:2,sag:1,tra:0},c=$("<div class='canvasWrapper'></div>"),this.$el.append(c),g=$("<div class='innerCanvasWrapper'></div>"),c.append(g),e=$("<canvas class='render_canvas' width='512' height='512'>"),this.canvas_scan=e.get(0),g.append(e),d=$("<canvas class='render_canvas' width='512' height='512'>"),this.canvas_overlay=d.get(0),g.append(this.canvas_overlay),this.input=$("<input class='slider' type='range'  min='0' max='216'/>"),this.$el.append(this.input),this.display=$("<span class='index'></span>"),this.$el.append(this.display),this.render(),this.model.on({change:this.render})},e.prototype.draw_scan=function(a,b,c){var d,e,f;for(d=e=0,f=a[0]*a[1];f>=0?f>e:e>f;d=f>=0?++e:--e)c[4*d]=b[d],c[4*d+1]=b[d],c[4*d+2]=b[d],c[4*d+3]=255},e.prototype.draw_overlay=function(a,b,c){var d,e,f,g;for(e=f=0,g=a[0]*a[1];g>=0?g>f:f>g;e=g>=0?++f:--f)d=this.cols[b[e]],c[4*e]=d[0],c[4*e+1]=d[1],c[4*e+2]=d[2],c[4*e+3]=b[e]<=24?5.3333*b[e]:128},e.prototype.render=function(){var a,b,c,d,e,f,g,h,i;return g=this.model.get("slice_dim"),e=this.model.get("slice_"+g),this.input.val(e),this.input.prop("max",this.model.get("matrix_shape")[this.dims[g]]-1),this.display.html(e),matrices.scan&&(h=matrices.scan.slice(this.dims[g],e),b=h[0],f=h[1],this.canvas_scan.height=f[0],this.canvas_scan.width=f[1],a=this.canvas_scan.getContext("2d"),c=a.createImageData(this.canvas_scan.width,this.canvas_scan.height),d=c.data,this.draw_scan(f,b,d),a.putImageData(c,0,0)),matrices[this.modality+"_"+this.overlay]?(i=matrices[this.modality+"_"+this.overlay].slice(this.dims[g],e),b=i[0],f=i[1],this.canvas_overlay.height=f[0],this.canvas_overlay.width=f[1],a=this.canvas_overlay.getContext("2d"),c=a.createImageData(this.canvas_overlay.width,this.canvas_overlay.height),d=c.data,this.draw_overlay(f,b,d),a.putImageData(c,0,0)):void 0},e.prototype.setControls=function(){var a;return a=this.model.get("slice_dim"),this.model.set("slice_"+a,parseInt(this.input.val()))},e.prototype.mouseWheel=function(a){var b,c,d,e,f;return d=this.model.get("slice_dim"),b=this.model.get("slice_"+d),(null!=(e=a.originalEvent)?e.wheelDelta:void 0)>0&&(b+=1,c=this.model.get("matrix_shape")[this.dims[d]]-1,b>c&&(b=c)),(null!=(f=a.originalEvent)?f.wheelDelta:void 0)<0&&(b-=1,0>b&&(b=0)),this.model.set("slice_"+d,b),!1},e.prototype.events={"input input":"setControls","mousewheel canvas":"mouseWheel"},e}(Backbone.View)}.call(this),function(){var a=function(a,b){return function(){return a.apply(b,arguments)}},b={}.hasOwnProperty,c=function(a,c){function d(){this.constructor=a}for(var e in c)b.call(c,e)&&(a[e]=c[e]);return d.prototype=c.prototype,a.prototype=new d,a.__super__=c.prototype,a};window.DispInfoView=function(b){function d(){return this.updateModalityBottom=a(this.updateModalityBottom,this),this.updateModalityTop=a(this.updateModalityTop,this),this.updateModel=a(this.updateModel,this),this.render=a(this.render,this),d.__super__.constructor.apply(this,arguments)}return c(d,b),d.prototype.initialize=function(){var a;return a=$('<label class="radio-inline"> <input type="radio" name="slice" id="cor" value="cor"> Coronal </label> <label class="radio-inline"> <input type="radio" name="slice" id="sag" value="sag"> Sagittal </label> <label class="radio-inline"> <input type="radio" name="slice" id="tra" value="tra"> Transverse </label> <br>       <label> Top: <select id="modality-top"> <option value="3D_Photon">3D Photon</option> <option value="IMRT" selected>IMRT</option> <option value="IMPT">IMPT</option> </select> </label> <label>Bottom:        <select id="modality-bottom"> <option value="3D_Photon">3D Photon</option> <option value="IMRT">IMRT</option> <option value="IMPT" selected>IMPT</option> </select></label>'),this.$el.append(a),this.updateModalityTop(),this.updateModalityBottom(),this.render,this.model.on({change:this.render})},d.prototype.render=function(){var a;return a=this.model.get("slice_dim"),this.$("#"+a).prop("checked",!0)},d.prototype.updateModel=function(){var a,b,c,d,e;for(d=["cor","tra","sag"],e=[],b=0,c=d.length;c>b;b++)a=d[b],e.push(this.$("#"+a).prop("checked")?this.model.set("slice_dim",a):void 0);return e},d.prototype.updateModalityTop=function(){var a;return a=this.$("#modality-top").val(),new PngMatrixProvider(a+"_ctr.png",function(a){return function(b,c){var d,e;return d=c[0],e=c[1],matrices.t_ctr=new Matrix(d,e),a.model.set({t_ctr_matrix:a.model.get("t_ctr_matrix")+1})}}(this)),new PngMatrixProvider(a+"_dose.png",function(a){return function(b,c){var d,e;return d=c[0],e=c[1],matrices.t_dose=new Matrix(d,e),a.model.set({t_dose_matrix:a.model.get("t_dose_matrix")+1})}}(this))},d.prototype.updateModalityBottom=function(){var a;return a=this.$("#modality-bottom").val(),new PngMatrixProvider(a+"_ctr.png",function(a){return function(b,c){var d,e;return d=c[0],e=c[1],matrices.b_ctr=new Matrix(d,e),a.model.set({b_ctr_matrix:a.model.get("b_ctr_matrix")+1})}}(this)),new PngMatrixProvider(a+"_dose.png",function(a){return function(b,c){var d,e;return d=c[0],e=c[1],matrices.b_dose=new Matrix(d,e),a.model.set({b_dose_matrix:a.model.get("b_dose_matrix")+1})}}(this))},d.prototype.events={"change input[type=radio]":"updateModel","change #modality-bottom":"updateModalityBottom","change #modality-top":"updateModalityTop"},d}(Backbone.View)}.call(this),function(){var a,b,c,d,e={}.hasOwnProperty,f=function(a,b){function c(){this.constructor=a}for(var d in b)e.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};a=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return f(b,a),b.prototype.defaults={slice_cor:276,slice_sag:250,slice_tra:108,matrix_shape:[216,512,512],scan_matrix:0,t_ctr_matrix:0,t_dose_matrix:0,b_ctr_matrix:0,b_dose_matrix:0,slice_dim:"cor",top_modality:"3D_Photon",bottom_modality:"IMPT"},b}(Backbone.Model),window.matrices={},matrices.scan=new Matrix(new Uint8Array(56623104),[216,512,512]),c=new a,d=new DispView({overlay:"dose",modality:"t",model:c,el:".topleft"}),d=new DispView({overlay:"ctr",modality:"t",model:c,el:".topright"}),d=new DispView({overlay:"dose",modality:"b",model:c,el:".bottomleft"}),d=new DispView({overlay:"ctr",modality:"b",model:c,el:".bottomright"}),b=new DispInfoView({model:c,el:".top"}),new PngMatrixProvider("scan.png",function(a,b){var d,e;return d=b[0],e=b[1],matrices.scan=new Matrix(d,e),c.set({scan_matrix:c.get("scan_matrix")+1,matrix_shape:e})})}.call(this);